(function(e){var k=e.Vector3DUtil;var h=e.JConfig;var i=e.Matrix3D;var f=e.JMatrix3D;var a=e.JNumber3D;var d=e.MaterialProperties;var b=e.PhysicsState;var g=e.PhysicsSystem;var j=e.JAABox;var c=e.JCollisionEvent;var l=function(m){e.JEventDispatcher.call(this);this._useDegrees=(h.rotationType=="DEGREES")?true:false;this._id=l.idCounter++;this._skin=m;this._material=new d();this._bodyInertia=new i();this._bodyInvInertia=f.getInverseMatrix(this._bodyInertia);this._currState=new b();this._oldState=new b();this._storeState=new b();this._invOrientation=f.getInverseMatrix(this._currState.get_orientation());this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];this._force=[0,0,0,0];this._torque=[0,0,0,0];this._linVelDamping=[0.995,0.995,0.995,0];this._rotVelDamping=[0.5,0.5,0.5,0];this._maxLinVelocities=500;this._maxRotVelocities=500;this._velChanged=false;this._inactiveTime=0;this._doShockProcessing=true;this.isActive=this._activity=true;this._movable=true;this._origMovable=true;this.collisions=[];this._constraints=[];this._nonCollidables=[];this._storedPositionForActivation=[0,0,0,0];this._bodiesToBeActivatedOnMovement=[];this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._type="Object3D";this._boundingSphere=0;this._boundingBox=new j([0,0,0,0],[0,0,0,0]);this._boundingBox.clear();};e.extend(l,e.JEventDispatcher);l.idCounter=0;l.prototype._id=null;l.prototype._skin=null;l.prototype._type=null;l.prototype._boundingSphere=null;l.prototype._boundingBox=null;l.prototype._currState=null;l.prototype._oldState=null;l.prototype._storeState=null;l.prototype._invOrientation=null;l.prototype._currLinVelocityAux=null;l.prototype._currRotVelocityAux=null;l.prototype._mass=null;l.prototype._invMass=null;l.prototype._bodyInertia=null;l.prototype._bodyInvInertia=null;l.prototype._worldInertia=null;l.prototype._worldInvInertia=null;l.prototype._force=null;l.prototype._torque=null;l.prototype._linVelDamping=null;l.prototype._rotVelDamping=null;l.prototype._maxLinVelocities=null;l.prototype._maxRotVelocities=null;l.prototype._velChanged=null;l.prototype._activity=null;l.prototype._movable=null;l.prototype._origMovable=null;l.prototype._inactiveTime=null;l.prototype._doShockProcessing=null;l.prototype._bodiesToBeActivatedOnMovement=null;l.prototype._storedPositionForActivation=null;l.prototype._lastPositionForDeactivation=null;l.prototype._lastOrientationForDeactivation=null;l.prototype._material=null;l.prototype._rotationX=0;l.prototype._rotationY=0;l.prototype._rotationZ=0;l.prototype._useDegrees=null;l.prototype._nonCollidables=null;l.prototype._constraints=null;l.prototype.collisions=null;l.prototype.isActive=null;l.prototype.minImpulseForCollisionEvent=1;l.prototype.dispatchCollisionEvent=function(m,n){if(k.getSum(n)<this.minImpulseForCollisionEvent){return;}this.dispatchEvent(new c(m,n));};l.prototype.radiansToDegrees=function(m){return m*180/Math.PI;};l.prototype.degreesToRadians=function(m){return m*Math.PI/180;};l.prototype.get_rotationX=function(){return this._rotationX;};l.prototype.get_rotationY=function(){return this._rotationY;};l.prototype.get_rotationZ=function(){return this._rotationZ;};l.prototype.set_rotationX=function(m){this._rotationX=m;this.setOrientation(this.createRotationMatrix());};l.prototype.set_rotationY=function(m){this._rotationY=m;this.setOrientation(this.createRotationMatrix());};l.prototype.set_rotationZ=function(m){this._rotationZ=m;this.setOrientation(this.createRotationMatrix());};l.prototype.setRotation=function(m){this._rotationX=m[0];this._rotationY=m[1];this._rotationZ=m[2];this.setOrientation(this.createRotationMatrix());};l.prototype.pitch=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.X_AXIS)));};l.prototype.yaw=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.Y_AXIS)));};l.prototype.roll=function(m){this.setOrientation(f.getAppendMatrix3D(this.get_currentState().orientation,f.getRotationMatrixAxis(m,k.Z_AXIS)));};l.prototype.createRotationMatrix=function(){var m=new i();m.appendRotation(this._rotationX,k.X_AXIS);m.appendRotation(this._rotationY,k.Y_AXIS);m.appendRotation(this._rotationZ,k.Z_AXIS);return m;};l.prototype.setOrientation=function(m){this._currState.set_orientation(m.clone());this.updateInertia();this.updateState();};l.prototype.get_position=function(){return this._currState.position;};l.prototype.get_x=function(){return this._currState.position[0];};l.prototype.get_y=function(){return this._currState.position[1];};l.prototype.get_z=function(){return this._currState.position[2];};l.prototype.set_x=function(m){this._currState.position[0]=m;this.updateState();};l.prototype.set_y=function(m){this._currState.position[1]=m;this.updateState();};l.prototype.set_z=function(m){this._currState.position[2]=m;this.updateState();};l.prototype.moveTo=function(m){this._currState.position=m.slice(0);this.updateState();};l.prototype.updateState=function(){this._currState.linVelocity=[0,0,0,0];this._currState.rotVelocity=[0,0,0,0];this.copyCurrentStateToOld();this.updateBoundingBox();this.setActive();};l.prototype.setVelocity=function(o,n){if(!n){this._currState.linVelocity=o.slice(0);}else{var m=this._currState.get_orientation();this._currState.linVelocity[0]=m.glmatrix[0]*o[0]+m.glmatrix[1]*o[1]+m.glmatrix[2]*o[2];this._currState.linVelocity[1]=m.glmatrix[4]*o[0]+m.glmatrix[5]*o[1]+m.glmatrix[6]*o[2];this._currState.linVelocity[2]=m.glmatrix[8]*o[0]+m.glmatrix[9]*o[1]+m.glmatrix[10]*o[2];}};l.prototype.setAngVel=function(m){this._currState.rotVelocity=m.slice(0);};l.prototype.setVelocityAux=function(m){this._currLinVelocityAux=m.slice(0);};l.prototype.setAngVelAux=function(m){this._currRotVelocityAux=m.slice(0);};l.prototype.addGravity=function(){if(!this._movable){return;}this._force=k.add(this._force,a.getScaleVector(e.PhysicsSystem.getInstance().get_gravity(),this._mass));this._velChanged=true;};l.prototype.addExternalForces=function(m){this.addGravity();};l.prototype.addWorldTorque=function(m){if(!this._movable){return;}this._torque=k.add(this._torque,m);this._velChanged=true;this.setActive();};l.prototype.addBodyTorque=function(m){if(!this._movable){return;}f.multiplyVector(this._currState.get_orientation(),m);this.addWorldTorque(m);};l.prototype.addWorldForce=function(m,n){if(!this._movable){return;}this._force=k.add(this._force,m);this.addWorldTorque(k.crossProduct(k.subtract(n,this._currState.position),m));this._velChanged=true;this.setActive();};l.prototype.addBodyForce=function(m,n){if(!this._movable){return;}f.multiplyVector(this._currState.get_orientation(),m);f.multiplyVector(this._currState.get_orientation(),n);this.addWorldForce(m,k.add(this._currState.position,n));};l.prototype.clearForces=function(){this._force=[0,0,0,0];this._torque=[0,0,0,0];};l.prototype.applyWorldImpulse=function(n,o){if(!this._movable){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(n,this._invMass));var m=k.crossProduct(k.subtract(o,this._currState.position),n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);this._velChanged=true;};l.prototype.applyWorldImpulseAux=function(n,o){if(!this._movable){return;}this._currLinVelocityAux=k.add(this._currLinVelocityAux,a.getScaleVector(n,this._invMass));var m=k.crossProduct(k.subtract(o,this._currState.position),n);f.multiplyVector(this._worldInvInertia,m);this._currRotVelocityAux=k.add(this._currRotVelocityAux,m);this._velChanged=true;};l.prototype.applyBodyWorldImpulse=function(n,o){if(!this._movable){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(n,this._invMass));var m=k.crossProduct(o,n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);this._velChanged=true;};l.prototype.applyBodyWorldImpulseAux=function(n,o){if(!this._movable){return;}this._currLinVelocityAux=k.add(this._currLinVelocityAux,a.getScaleVector(n,this._invMass));var m=k.crossProduct(o,n);f.multiplyVector(this._worldInvInertia,m);this._currRotVelocityAux=k.add(this._currRotVelocityAux,m);this._velChanged=true;};l.prototype.addConstraint=function(m){if(!this.findConstraint(m)){this._constraints.push(m);}};l.prototype.removeConstraint=function(m){if(this.findConstraint(m)){this._constraints.splice(this._constraints.indexOf(m),1);}};l.prototype.removeAllConstraints=function(){this._constraints=[];};l.prototype.findConstraint=function(o){for(var n=0,m=this._constraints.length;n<m;n++){if(o==this._constraints[n]){return true;}}return false;};l.prototype.updateVelocity=function(n){if(!this._movable||!this._activity){return;}this._currState.linVelocity=k.add(this._currState.linVelocity,a.getScaleVector(this._force,this._invMass*n));var m=a.getScaleVector(this._torque,n);f.multiplyVector(this._worldInvInertia,m);this._currState.rotVelocity=k.add(this._currState.rotVelocity,m);};l.prototype.updatePositionWithAux=function(r){if(!this._movable||!this._activity){this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];return;}var s=e.PhysicsSystem.getInstance().get_gravityAxis();if(s!=-1){var m=this._currLinVelocityAux.slice(0);m[(s+1)%3]*=0.1;m[(s+2)%3]*=0.1;a.copyFromArray(this._currLinVelocityAux,m);}var o=this._currState.rotVelocity.slice(0);f.multiplyVector(this._worldInertia,o);this._currState.position=k.add(this._currState.position,a.getScaleVector(k.add(this._currState.linVelocity,this._currLinVelocityAux),r));var q=k.add(this._currState.rotVelocity,this._currRotVelocityAux);var p=k.get_length(q)*180/Math.PI;if(p>0){k.normalize(q);p*=r;var n=f.getRotationMatrix(q[0],q[1],q[2],p);this._currState.set_orientation(f.getAppendMatrix3D(this._currState.get_orientation(),n));this.updateInertia();}this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];f.multiplyVector(this._worldInvInertia,o);this._currState.rotVelocity=o.slice(0);this.updateBoundingBox();};l.prototype.postPhysics=function(m){};l.prototype.tryToFreeze=function(n){if(!this._movable||!this._activity){return;}if(k.get_length(k.subtract(this._currState.position,this._lastPositionForDeactivation))>h.posThreshold){this._lastPositionForDeactivation=this._currState.position.slice(0);this._inactiveTime=0;return;}var m=h.orientThreshold;var p=f.getSubMatrix(this._currState.get_orientation(),this._lastOrientationForDeactivation);var o=f.getCols(p);if(k.get_length(o[0])>m||k.get_length(o[1])>m||k.get_length(o[2])>m){this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._inactiveTime=0;return;}if(this.getShouldBeActive()){return;}this._inactiveTime+=n;if(this._inactiveTime>h.deactivationTime){this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this.setInactive();}};l.prototype.set_mass=function(n){this._mass=n;this._invMass=1/n;this.setInertia(this.getInertiaProperties(n));};l.prototype.setInertia=function(m){this._bodyInertia=m.clone();this._bodyInvInertia=f.getInverseMatrix(this._bodyInertia.clone());this.updateInertia();};l.prototype.updateInertia=function(){this._invOrientation=f.getTransposeMatrix(this._currState.get_orientation());this._worldInertia=f.getAppendMatrix3D(this._invOrientation,f.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInertia));this._worldInvInertia=f.getAppendMatrix3D(this._invOrientation,f.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInvInertia));};l.prototype.get_movable=function(){return this._movable;};l.prototype.set_movable=function(m){if(this._type=="PLANE"||this._type=="TERRAIN"||this._type=="TRIANGLEMESH"){return;}this._movable=m;this.isActive=this._activity=m;this._origMovable=m;};l.prototype.internalSetImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"||this._type=="TRIANGLEMESH"){return;}this._origMovable=this._movable;this._movable=false;};l.prototype.internalRestoreImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"||this._type=="TRIANGLEMESH"){return;}this._movable=this._origMovable;};l.prototype.getVelChanged=function(){return this._velChanged;};l.prototype.clearVelChanged=function(){this._velChanged=false;};l.prototype.setActive=function(m){if(!m){m=1;}if(this._movable){this.isActive=this._activity=true;this._inactiveTime=(1-m)*h.deactivationTime;}};l.prototype.setInactive=function(){if(this._movable){this.isActive=this._activity=false;}};l.prototype.getVelocity=function(m){return k.add(this._currState.linVelocity,k.crossProduct(this._currState.rotVelocity,m));};l.prototype.getVelocityAux=function(m){return k.add(this._currLinVelocityAux,k.crossProduct(this._currRotVelocityAux,m));};l.prototype.getShouldBeActive=function(){return((k.get_length(this._currState.linVelocity)>h.velThreshold)||(k.get_length(this._currState.rotVelocity)>h.angVelThreshold));};l.prototype.getShouldBeActiveAux=function(){return((k.get_length(this._currLinVelocityAux)>h.velThreshold)||(k.get_length(this._currRotVelocityAux)>h.angVelThreshold));};l.prototype.dampForDeactivation=function(){this._currState.linVelocity[0]*=this._linVelDamping[0];this._currState.linVelocity[1]*=this._linVelDamping[1];this._currState.linVelocity[2]*=this._linVelDamping[2];this._currState.rotVelocity[0]*=this._rotVelDamping[0];this._currState.rotVelocity[1]*=this._rotVelDamping[1];this._currState.rotVelocity[2]*=this._rotVelDamping[2];this._currLinVelocityAux[0]*=this._linVelDamping[0];this._currLinVelocityAux[1]*=this._linVelDamping[1];this._currLinVelocityAux[2]*=this._linVelDamping[2];this._currRotVelocityAux[0]*=this._rotVelDamping[0];this._currRotVelocityAux[1]*=this._rotVelDamping[1];this._currRotVelocityAux[2]*=this._rotVelDamping[2];var n=0.5;var m=this._inactiveTime/h.deactivationTime;if(m<n){return;}var o=1-((m-n)/(1-n));if(o<0){o=0;}else{if(o>1){o=1;}}this._currState.linVelocity=a.getScaleVector(this._currState.linVelocity,o);this._currState.rotVelocity=a.getScaleVector(this._currState.rotVelocity,o);};l.prototype.doMovementActivations=function(){var m=this._bodiesToBeActivatedOnMovement.length;if(m==0||k.get_length(k.subtract(this._currState.position,this._storedPositionForActivation))<h.posThreshold){return;}for(var n=0;n<m;n++){e.PhysicsSystem.getInstance().activateObject(this._bodiesToBeActivatedOnMovement[n]);}this._bodiesToBeActivatedOnMovement=[];};l.prototype.addMovementActivation=function(p,o){var m=this._bodiesToBeActivatedOnMovement.length;for(var n=0;n<m;n++){if(this._bodiesToBeActivatedOnMovement[n]==o){return;}}if(this._bodiesToBeActivatedOnMovement.length==0){this._storedPositionForActivation=p;}this._bodiesToBeActivatedOnMovement.push(o);};l.prototype.setConstraintsAndCollisionsUnsatisfied=function(){for(var n=0,m=this._constraints.length;n<m;n++){this._constraints[n].set_satisfied(false);}for(var n=0,o=this.collisions.length;n<o;n++){this.collisions[n].satisfied=false;}};l.prototype.segmentIntersect=function(n,m,o){return false;};l.prototype.getInertiaProperties=function(n){return new i();};l.prototype.updateBoundingBox=function(){};l.prototype.hitTestObject3D=function(m){var o=k.get_length(k.subtract(this._currState.position,m.get_currentState().position));var n=this._boundingSphere+m.get_boundingSphere();if(o<=n){return true;}return false;};l.prototype.findNonCollidablesBody=function(m){for(var o=0,n=this._nonCollidables.length;o<n;o++){if(m==this._nonCollidables[o]){return true;}}return false;};l.prototype.disableCollisions=function(m){if(!this.findNonCollidablesBody(m)){this._nonCollidables.push(m);}};l.prototype.enableCollisions=function(m){if(this.findNonCollidablesBody(m)){this._nonCollidables.splice(this._nonCollidables.indexOf(m),1);}};l.prototype.copyCurrentStateToOld=function(){this._oldState.position=this._currState.position.slice(0);this._oldState.set_orientation(this._currState.get_orientation().clone());
this._oldState.linVelocity=this._currState.linVelocity.slice(0);this._oldState.rotVelocity=this._currState.rotVelocity.slice(0);};l.prototype.storeState=function(){this._storeState.position=this._currState.position.slice(0);this._storeState.set_orientation(this._currState.get_orientation().clone());this._storeState.linVelocity=this._currState.linVelocity.slice(0);this._storeState.rotVelocity=this._currState.rotVelocity.slice(0);};l.prototype.restoreState=function(){this._currState.position=this._storeState.position.slice(0);this._currState.set_orientation(this._storeState.get_orientation().clone());this._currState.linVelocity=this._storeState.linVelocity.slice(0);this._currState.rotVelocity=this._storeState.rotVelocity.slice(0);};l.prototype.get_currentState=function(){return this._currState;};l.prototype.get_oldState=function(){return this._oldState;};l.prototype.get_id=function(){return this._id;};l.prototype.get_type=function(){return this._type;};l.prototype.get_skin=function(){return this._skin;};l.prototype.get_boundingSphere=function(){return this._boundingSphere;};l.prototype.get_boundingBox=function(){return this._boundingBox;};l.prototype.get_force=function(){return this._force;};l.prototype.get_mass=function(){return this._mass;};l.prototype.get_invMass=function(){return this._invMass;};l.prototype.get_worldInertia=function(){return this._worldInertia;};l.prototype.get_worldInvInertia=function(){return this._worldInvInertia;};l.prototype.get_nonCollidables=function(){return this._nonCollidables;};l.prototype.get_doShockProcessing=function(){return this._doShockProcessing;};l.prototype.set_doShockProcessing=function(m){this._doShockProcessing=m;};l.prototype.set_linVelocityDamping=function(m){this._linVelDamping[0]=a.getLimiteNumber(m[0],0,1);this._linVelDamping[1]=a.getLimiteNumber(m[1],0,1);this._linVelDamping[2]=a.getLimiteNumber(m[2],0,1);};l.prototype.get_linVelocityDamping=function(){return this._linVelDamping;};l.prototype.set_rotVelocityDamping=function(m){this._rotVelDamping[0]=a.getLimiteNumber(m[0],0,1);this._rotVelDamping[1]=a.getLimiteNumber(m[1],0,1);this._rotVelDamping[2]=a.getLimiteNumber(m[2],0,1);};l.prototype.get_rotVelocityDamping=function(){return this._rotVelDamping;};l.prototype.set_maxLinVelocities=function(m){this._maxLinVelocities=a.getLimiteNumber(Math.abs(m),0,500);};l.prototype.get_maxLinVelocities=function(){return this._maxLinVelocities;};l.prototype.set_maxRotVelocities=function(m){this._maxRotVelocities=a.getLimiteNumber(Math.abs(m),a.NUM_TINY,50);};l.prototype.get_maxRotVelocities=function(){return this._maxRotVelocities;};l.prototype.limitVel=function(){this._currState.linVelocity[0]=a.getLimiteNumber(this._currState.linVelocity[0],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[1]=a.getLimiteNumber(this._currState.linVelocity[1],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[2]=a.getLimiteNumber(this._currState.linVelocity[2],-this._maxLinVelocities,this._maxLinVelocities);};l.prototype.limitAngVel=function(){var o=Math.abs(this._currState.rotVelocity[0])/this._maxRotVelocities;var n=Math.abs(this._currState.rotVelocity[1])/this._maxRotVelocities;var m=Math.abs(this._currState.rotVelocity[2])/this._maxRotVelocities;var p=Math.max(o,n,m);if(p>1){this._currState.rotVelocity=a.getDivideVector(this._currState.rotVelocity,p);}};l.prototype.getTransform=function(){if(this._skin!=null){return this._skin.get_transform();}else{return null;}};l.prototype.updateObject3D=function(){if(this._skin!=null){this._skin.set_transform(f.getAppendMatrix3D(this._currState.get_orientation(),f.getTranslationMatrix(this._currState.position[0],this._currState.position[1],this._currState.position[2])));}};l.prototype.get_material=function(){return this._material;};l.prototype.get_restitution=function(){return this._material.get_restitution();};l.prototype.set_restitution=function(m){this._material.set_restitution(a.getLimiteNumber(m,0,1));};l.prototype.get_friction=function(){return this._material.get_friction();};l.prototype.set_friction=function(m){this._material.set_friction(a.getLimiteNumber(m,0,1));};e.RigidBody=l;})(jigLib);