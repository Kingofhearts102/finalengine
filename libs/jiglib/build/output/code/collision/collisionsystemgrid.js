(function(c){var g=c.Vector3DUtil;var e=c.CollOutBodyData;var f=c.JAABox;var h=c.JSegment;var i=c.JMath3D;var a=c.JNumber3D;var j=c.RigidBody;var b=c.CollisionSystemGridEntry;var d=c.CollDetectInfo;var k=function(t,s,r,p,o,n,w,v,u){this.Super();if(t==undefined){t=0;}if(s==undefined){s=0;}if(r==undefined){r=0;}if(p==undefined){p=20;}if(o==undefined){o=20;}if(n==undefined){n=20;}if(w==undefined){w=200;}if(v==undefined){v=200;}if(u==undefined){u=200;}this.nx=p;this.ny=o;this.nz=n;this.dx=w;this.dy=v;this.dz=u;this.sizeX=p*w;this.sizeY=o*v;this.sizeZ=n*u;this.minDelta=Math.min(w,v,u);this.startpoint=[t,s,r];this.gridEntries=[];var q=this.gridEntries.length;for(var m=0;m<q;++m){var l=new b(null);l.gridIndex=m;this.gridEntries[m]=l;}this.overflowEntries=new b(null);this.overflowEntries.gridIndex=-1;};c.extend(k,c.CollisionSystemAbstract);k.prototype.gridEntries=null;k.prototype.overflowEntries=null;k.prototype.nx=0;k.prototype.ny=0;k.prototype.nz=0;k.prototype.dx=0;k.prototype.dy=0;k.prototype.dz=0;k.prototype.sizeX=0;k.prototype.sizeY=0;k.prototype.sizeZ=0;k.prototype.minDelta=0;k.prototype.calcIndex=function(n,m,l){var q=n%this.nx;var p=m%this.ny;var o=l%this.nz;return(q+this.nx*p+(this.nx+this.ny)*o);};k.prototype.calcGridForSkin3=function(m){var p;var n;var l;var q=m.get_boundingBox().get_sideLengths();if((q[0]>this.dx)||(q[1]>this.dy)||(q[2]>this.dz)){p=n=l=-1;return[p,n,l];}var o=m.get_boundingBox().get_minPos();o[0]=i.wrap(o[0],this.startpoint[0],this.startpoint[0]+this.sizeX);o[1]=i.wrap(o[1],this.startpoint[1],this.startpoint[1]+this.sizeY);o[2]=i.wrap(o[2],this.startpoint[2],this.startpoint[2]+this.sizeZ);p=(((o[0]-this.startpoint[0])/this.dx)%this.nx)|0;n=(((o[1]-this.startpoint[1])/this.dy)%this.ny)|0;l=(((o[2]-this.startpoint[2])/this.dz)%this.nz)|0;return[p,n,l];};k.prototype.calcGridForSkin6=function(m){var r={};var q;var p;var n;var u;var t;var s;var l=m.get_boundingBox().get_sideLengths();if((l[0]>this.dx)||(l[1]>this.dy)||(l[2]>this.dz)){q=p=n=-1;u=t=s=0;r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;}var o=m.get_boundingBox().get_minPos();o[0]=i.getLimiteNumber(o[0],this.startpoint[0],this.startpoint[0]+this.sizeX);o[1]=i.getLimiteNumber(o[1],this.startpoint[1],this.startpoint[1]+this.sizeY);o[2]=i.getLimiteNumber(o[2],this.startpoint[2],this.startpoint[2]+this.sizeZ);u=(o[0]-this.startpoint[0])/this.dx;t=(o[1]-this.startpoint[1])/this.dy;s=(o[2]-this.startpoint[2])/this.dz;q=u;p=t;n=s;if(q<0){q=0;u=0;}else{if(q>=this.nx){q=0;u=0;}else{u-=q;}}if(p<0){p=0;t=0;}else{if(p>=this.ny){p=0;t=0;}else{t-=p;}}if(n<0){n=0;s=0;}else{if(n>=this.nz){n=0;s=0;}else{s-=n;}}r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;};k.prototype.calcGridIndexForBody=function(m){var l=this.calcGridForSkin3(m);if(l.x==-1){return -1;}return this.calcIndex(l[0],l[1],l[2]);};k.prototype.addCollisionBody=function(l){if(!this.findBody(l)){this.collBody.push(l);}l.collisionSystem=this;var m=new b(l);l.externalData=m;b.insertGridEntryAfter(m,this.overflowEntries);this.collisionSkinMoved(l);};k.prototype.removeCollisionBody=function(l){if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);l.externalData=null;}if(this.findBody(l)){this.collBody.splice(this.collBody.indexOf(l),1);}};k.prototype.removeAllCollisionBodies=function(){for(var m=0;m<this.collBody.length;m++){var l=this.collBody[m];if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);}}collBody=[];};k.prototype.collisionSkinMoved=function(l){var o=l.externalData;if(o==null){return;}var n=this.calcGridIndexForBody(l);if(n==o.gridIndex){return;}var p;var m=this.gridEntries;if(m.length-1>n&&n>=0){p=m[n];}else{p=this.overflowEntries;}b.removeGridEntry(o);b.insertGridEntryAfter(o,p);};k.prototype.getListsToCheck=function(l){var u=[];var m=l.externalData;if(m==null){return null;}var z;var x;var w;var t;var s;var r;var C=this.calcGridForSkin6(l);z=C.i;x=C.j;w=C.k;t=C.fi;s=C.fj;r=C.fk;if(z==-1){u=this.gridEntries.concat();u.push(this.overflowEntries);return u;}u.push(this.overflowEntries);var D=l.get_boundingBox().get_sideLengths();var p=1,o=1,n=1;if(t+(D[0]/this.dx)<1){p=0;}if(s+(D[1]/this.dy)<1){o=0;}if(r+(D[2]/this.dz)<1){n=0;}for(var B=-1;B<=p;++B){for(var A=-1;A<=o;++A){for(var y=-1;y<=n;++y){var v=this.calcIndex(this.nx+z+B,this.ny+x+A,this.nz+w+y);if(this.gridEntries.length-1>v&&v>=0){var q=this.gridEntries[v];if(q!=null&&q.next!=null){u.push(q);}}}}}return u;};k.prototype.detectAllCollisions=function(l,s){var m;var q;var n;var t;this._numCollisionsChecks=0;for(var p=0;p<l.length;p++){var r=l[p];if(!r.isActive){continue;}n=r.get_id();t=r.get_type();var v=this.getListsToCheck(r);for(var o=0;o<v.length;o++){var u=v[o];for(u=u.next;u!=null;u=u.next){if(r==u.collisionBody){continue;}if(u.collisionBody&&u.collisionBody.isActive&&n>u.collisionBody.get_id()){continue;}if(this.checkCollidables(r,u.collisionBody)&&this.detectionFunctors[t+"_"+u.collisionBody.get_type()]!=undefined){m=new d();m.body0=r;m.body1=u.collisionBody;q=this.detectionFunctors[m.body0.get_type()+"_"+m.body1.get_type()];q.collDetect(m,s);this._numCollisionsChecks+=1;}}}}};c.CollisionSystemGrid=k;})(jigLib);