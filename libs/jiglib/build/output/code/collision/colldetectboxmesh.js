(function(r){var j=r.Vector3DUtil;var h=r.JNumber3D;var s=r.JConstraint;var b=r.JConfig;var i=r.JSphere;var l=r.MaterialProperties;var k=r.RigidBody;var p=r.CollPointInfo;var a=r.CollisionInfo;var q=r.JBox;var e=r.JIndexedTriangle;var n=r.JSegment;var g=r.JTriangle;var f=r.JTriangleMesh;var o=r.CollOutData;var c=r.EdgeData;var d=r.SpanDatadot;var d=r.SpanData;var m=function(){this.name="BoxMesh";this.type0="BOX";this.type1="TRIANGLEMESH";};r.extend(m,r.CollDetectFunctor);m.prototype.disjoint=function(z,w,C,B){var y=C.getSpan(w);var x=B.getSpan(w);var u=y.min,A=y.max,D=x.min,v=x.max,t=h.NUM_TINY;if(u>(v+b.collToll+t)||D>(A+b.collToll+t)){z.flag=true;return true;}if((A>v)&&(D>u)){z.depth=Math.min(A-D,v-u);}else{if((v>A)&&(u>D)){z.depth=Math.min(v-u,A-D);}else{z.depth=Math.min(A,v);z.depth-=Math.max(u,D);}}z.flag=false;return false;};m.prototype.addPoint=function(w,v,t){for(var u=0;u<w.length;u++){var x=w[u];if(j.get_lengthSquared(j.subtract(x,v))<t){x=j.add(x,v);j.scaleBy(x,0.5);return false;}}w.push(v);return true;};m.prototype.getBoxTriangleIntersectionPoints=function(E,A,z,D){var w=A.get_edges();var t=A.getCornerPoints(A.get_currentState());var y;var u;var v;for(var x=0;x<12;x++){u=w[x];y=new o();v=new n(t[u.ind0],j.subtract(t[u.ind1],t[u.ind0]));if(z.segmentTriangleIntersection(y,v)){this.addPoint(E,v.getPoint(y.frac),D);if(E.length>8){return E.length;}}}var C,B;for(x=0;x<3;x++){C=z.getVertex(x);B=z.getVertex((x+1)%3);y=new o();if(A.segmentIntersect(y,new n(C,j.subtract(B,C)),A.get_currentState())){this.addPoint(E,y.position,D);if(E.length>8){return E.length;}}if(A.segmentIntersect(y,new n(B,j.subtract(C,B)),A.get_currentState())){this.addPoint(E,y.position,D);if(E.length>8){return E.length;}}}return E.length;};m.prototype.doOverlapBoxTriangleTest=function(B,S,t,X,T){var P,K,J,W,H,y,C,Z,V,ab;var F=B.get_currentState().getOrientationCols();var O=new g(t.get_octree().getVertex(S.getVertexIndex(0)),t.get_octree().getVertex(S.getVertexIndex(1)),t.get_octree().getVertex(S.getVertexIndex(2)));P=j.subtract(O.getVertex(1),O.getVertex(0));j.normalize(P);K=j.subtract(O.getVertex(2),O.getVertex(1));j.normalize(K);J=j.subtract(O.getVertex(0),O.getVertex(2));j.normalize(J);var W=S.get_plane().normal.slice(0);var E=13;var R=[W,F[0],F[1],F[2],j.crossProduct(F[0],P),j.crossProduct(F[0],K),j.crossProduct(F[0],J),j.crossProduct(F[1],P),j.crossProduct(F[1],K),j.crossProduct(F[1],J),j.crossProduct(F[2],P),j.crossProduct(F[2],K),j.crossProduct(F[2],J)];var A=[];for(var Q=0;Q<E;Q++){A[Q]=new d();if(this.disjoint(A[Q],R[Q],B,O)){return false;}}var G=-1;var w=h.NUM_TINY,Y=h.NUM_HUGE,I,z,ac,u,aa;for(Q=0;Q<E;Q++){I=j.get_lengthSquared(R[Q]);if(I<w){continue;}z=1/Math.sqrt(I);j.scaleBy(R[Q],z);A[Q].depth*=z;if(A[Q].depth<Y){Y=A[Q].depth;G=Q;}}if(G==-1){return false;}H=j.subtract(B.get_currentState().position,O.getCentre());y=R[G];ac=A[G].depth;if(j.dotProduct(H,y)<0){j.negate(y);}C=B.get_oldState().position;Z=B.get_currentState().position;V=t.get_currentState().position;var ad=[];u=ac+0.05;this.getBoxTriangleIntersectionPoints(ad,B,O,u*u);ab=j.subtract(Z,C);aa=ac+j.dotProduct(ab,y);var v=ad.length;var M=[];if(v>0){var x;for(Q=0;Q<v;Q++){x=new p();x.r0=j.subtract(ad[Q],Z);x.r1=j.subtract(ad[Q],V);x.initialPenetration=aa;M[Q]=x;}var L=new a();L.objInfo=X;L.dirToBody=y;L.pointInfo=M;var U=new l();U.set_restitution(0.5*(B.get_material().get_restitution()+t.get_material().get_restitution()));U.set_friction(0.5*(B.get_material().get_friction()+t.get_material().get_friction()));L.mat=U;T.push(L);X.body0.collisions.push(L);X.body1.collisions.push(L);return true;}else{return false;}};m.prototype.collDetectBoxStaticMeshOverlap=function(x,E,u,B){var v=x.get_boundingSphere();var D=x.get_currentState().position;var w=[];var t=E.get_octree().getTrianglesIntersectingtAABox(w,x.get_boundingBox());var C=false;var z;var y;for(var A=0;A<t;++A){y=E.get_octree().getTriangle(w[A]);z=y.get_plane().pointPlaneDistance(D);if(z>v||z<0){continue;}if(this.doOverlapBoxTriangleTest(x,y,E,u,B)){C=true;}}return C;};m.prototype.collDetect=function(w,v){var t;if(w.body0.type=="TRIANGLEMESH"){t=w.body0;w.body0=w.body1;w.body1=t;}var u=w.body0;var x=w.body1;this.collDetectBoxStaticMeshOverlap(u,x,w,v);};r.CollDetectBoxMesh=m;})(jigLib);